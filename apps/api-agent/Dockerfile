# ä½¿ç”¨ Debian é•œåƒ, é¿å… Alpine å…¼å®¹æ€§é—®é¢˜
FROM node:20-slim AS base

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    procps \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
RUN npm install -g turbo pnpm

# Pruner é˜¶æ®µ - è£å‰ªé¡¹ç›®
FROM base AS pruner
WORKDIR /app
COPY . .
RUN turbo prune --scope=api-agent --docker

# ä¾èµ–å®‰è£…é˜¶æ®µ
FROM base AS installer
WORKDIR /app

# é¦–å…ˆå¤åˆ¶è£å‰ªåçš„ package.json æ–‡ä»¶
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/pnpm-lock.yaml ./pnpm-lock.yaml

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¼€å‘é˜¶æ®µ
FROM installer AS development
WORKDIR /app

# å¤åˆ¶è£å‰ªåçš„å®Œæ•´æºç 
COPY --from=pruner /app/out/full/ .

COPY apps/api-agent/.env.development ./apps/api-agent/.env

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
RUN cd apps/api-agent && pnpm run db:generate

# æ·»åŠ æ•°æ®åº“è¿ç§»è„šæœ¬
RUN echo '#!/bin/sh\n\
set -e\n\
echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."\n\
cd /app/apps/api-agent && pnpm run db:deploy\n\
echo "âœ… è¿ç§»å®Œæˆï¼"\n\
echo "ğŸš€ å¯åŠ¨åº”ç”¨..."\n\
exec "$@"' > /usr/local/bin/docker-entrypoint.sh && chmod +x /usr/local/bin/docker-entrypoint.sh

# è®¾ç½®ç¯å¢ƒå˜é‡ç¡®ä¿NestJSç»‘å®šåˆ°æ­£ç¡®çš„ä¸»æœº
ENV HOST=0.0.0.0
ENV PORT=3001

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¼€å‘æ¨¡å¼å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["turbo", "run", "dev", "--filter=api-agent"]

# æ„å»ºé˜¶æ®µ
FROM installer AS builder
WORKDIR /app

# å¤åˆ¶è£å‰ªåçš„å®Œæ•´æºç 
COPY --from=pruner /app/out/full/ .

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯å¹¶æ„å»º
RUN cd apps/api-agent && pnpm run db:generate
RUN turbo run build --filter=api-agent

# ç”Ÿäº§é˜¶æ®µ
FROM node:20-slim AS production
WORKDIR /app

# ç”Ÿäº§ç¯å¢ƒä¹Ÿéœ€è¦ OpenSSL
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=pruner /app/out/json/package.json ./
COPY --from=pruner /app/out/json/pnpm-lock.yaml ./
COPY --from=pruner /app/out/json/apps/api-agent/package.json ./apps/api-agent/

# åªå®‰è£…ç”Ÿäº§ä¾èµ–
RUN pnpm install --frozen-lockfile --prod

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/apps/api-agent/dist ./apps/api-agent/dist
COPY --from=builder /app/apps/api-agent/prisma ./apps/api-agent/prisma
COPY --from=builder /app/apps/api-agent/node_modules/.prisma ./apps/api-agent/node_modules/.prisma

# æš´éœ²ç«¯å£
EXPOSE 3001

# ç”Ÿäº§æ¨¡å¼å¯åŠ¨å‘½ä»¤
CMD ["node", "apps/api-agent/dist/main"]